var GrpnPlace=function(e,o){this.name=ko.observable(e.merchant.name),this.location=ko.observable(e.options[0].redemptionLocations[0]),this.lat=ko.observable(this.location().lat),this.lng=ko.observable(this.location().lng),this.loc=ko.observable(new google.maps.LatLng(this.lat(),this.lng())),this.neighborhood=ko.observable(this.location().neighborhood),this.address=ko.observable(this.location().streetAddress1),this.city=ko.observable(this.location().city),this.postal=ko.observable(this.location().postal),this.phone=this.location().phoneNumber||"No phone number provided",this.rating=ko.observable(e.grouponRating),this.grpnUrl=ko.observable(e.dealUrl),this.title=ko.observable(e.title),this.html=ko.observable(e.highlightsHtml),this.pitch=ko.observable(e.pitchHtml),this.content="<a href="+this.grpnUrl()+' target="_blank"><h3>'+this.title()+"</h3></a>"+this.html()+this.pitch()+"<p>Address: "+this.address()+"</p><p>Phone: "+this.phone+"</p>",this.marker=new google.maps.Marker({position:this.loc(),map:o.map}),o.markers.push(this.marker),google.maps.event.addListener(this.marker,"click",function(e,t,n){return function(){n.setContent(t),o.map.panTo(e.getPosition()),n.open(o.map,e)}}(this.marker,this.content,o.infowindow)),this.onClick=function(){$(".menu-icon-link").trigger("click"),google.maps.event.trigger(this.marker,"click")}},ViewModel=function(){var e=this,o={};e.markers=ko.observableArray([]),e.venues=ko.observableArray([]),e.picks=ko.observableArray(e.venues()),e.neighborhood=ko.observable("San Francisco"),e.dealType=ko.observable("food-and-drink"),e.channels=ko.observableArray(["automotive","beauty-and-spas","food-and-drink","health-and-fitness","home-improvement","local-services","shopping","things-to-do"]),e.grpnPlaceList=ko.observableArray([]),e.filter=ko.observable(),e.setAllMap=function(o){ko.utils.arrayForEach(e.markers(),function(e){e.setMap(o)})},e.clearMarkers=function(){e.setAllMap(null)},e.showMarkers=function(){e.setAllMap(e.map)},e.deleteMarkers=function(){e.clearMarkers(),e.markers.removeAll()},e.filteredList=ko.computed(function(){if(e.filter()){var o=[];return e.clearMarkers(),ko.utils.arrayForEach(e.grpnPlaceList(),function(t){t.name().toLowerCase().indexOf(e.filter().toLowerCase())>=0&&(o.push(t),t.marker.setMap(e.map))}),o}return e.showMarkers(),e.grpnPlaceList()},this),e.init=function(){e.initMap(),e.getComplete(),$(".menu-icon-link").click(function(e){e.preventDefault(),$("#wrapper").toggleClass("toggled"),$("#sidebar-wrapper").toggleClass("toggled"),$("#page-content-wrapper").toggleClass("toggled")}),google.maps.event.addDomListener(e.map,"idle",function(){e.calculateCenter()}),google.maps.event.addDomListener(window,"resize",function(){e.map.setCenter(e.center)}),e.dealType.subscribe(function(o){e.getDeals()})},e.initMap=function(){if("undefined"==typeof google)return void $("#mapDiv").html("<h1>There was an error loading Google Maps</h1><h1>Please check your internet or firewall</h1>");var o={zoom:10,disableDefaultUI:!1,mapTypeId:google.maps.MapTypeId.ROADMAP};e.map=new google.maps.Map(document.querySelector("#mapDiv"),o),e.infowindow=new google.maps.InfoWindow},e.getComplete=function(){$.ajax({type:"get",dataType:"jsonp",url:"https://partner-api.groupon.com/division.json",success:function(t){$.each(t.divisions,function(){o[this.name]={id:this.id,lat:this.lat,lng:this.lng}}),e.formattedNeighborhood=ko.computed(function(){return o[e.neighborhood()]}),$("#neigh").autocomplete({source:Object.keys(o),select:function(o,t){$("#grpnHeaderElem").text("Loading deals"),e.neighborhood(t.item.label),e.getDeals()}}),e.getDeals()},error:function(e,o,t){$("#loading").hide(),console.log(t)}})},e.getDeals=function(){var t="https://partner-api.groupon.com/deals.json?tsToken=US_AFF_0_203765_212556_0";e.grpnPlaceList.removeAll(),e.deleteMarkers(),e.formattedNeighborhood=ko.computed(function(){return"&lat="+o[e.neighborhood()].lat+"&lng="+o[e.neighborhood()].lng+"&radius=25"},e),$("#loading").show(),$("#filter").hide(),$.ajax({type:"get",url:t+e.formattedNeighborhood()+"&offset=0&limit=20&filters=category:"+e.dealType(),dataType:"jsonp",timeout:5e3}).done(function(o){$("#loading").hide(),$("#filter").show();var t=new google.maps.LatLngBounds;$.each(o.deals,function(){dataHTML="";var o=this.options[0].redemptionLocations;return void 0===o||0===o.length?!0:(e.grpnPlaceList.push(new GrpnPlace(this,e)),void t.extend(new google.maps.LatLng(o[0].lat,o[0].lng)))}),e.map.fitBounds(t),e.map.setCenter(t.getCenter()),$("#grpnHeaderElem").text("Showing deals near "+e.neighborhood())}).fail(function(e,o,t){$("#grpnHeaderElem").text("Unable to load deals.")}).always(function(){$("#loading").hide()})},e.getStars=function(){$.fn.stars=function(){return $(this).each(function(){var e=parseFloat($(this).html());e=Math.round(4*e)/4;var o=16*Math.max(0,Math.min(5,e)),t=$("<span />").width(o);$(this).html(t)})},$(function(){$("span.stars").stars()})},e.calculateCenter=function(){e.center=e.map.getCenter()},e.init()};$(document).ready(function(){ko.applyBindings(new ViewModel)});